---
import { getCollection } from 'astro:content';
import CraftLayout from '../../components/craft/CraftLayout.astro';
import ContentGrid from '../../components/craft/ContentGrid.astro';
import MediaCard from '../../components/craft/MediaCard.astro';
import GhostSearch from '../../components/craft/GhostSearch.astro';
import JourneyCalendarCanvas from '../../components/journey/JourneyCalendarCanvas.astro';

// Build-time data fetching for journey content (if any)
const journeyItems = await getCollection('journey', ({ data }: any) => {
	return data.draft !== true; // Only published content
}).catch(() => []); // Handle case where journey collection doesn't exist yet

// Sort by date, featured first
const sortedJourneyItems = journeyItems.sort((a: any, b: any) => {
	if (a.data.featured && !b.data.featured) return -1;
	if (!a.data.featured && b.data.featured) return 1;
	return new Date(b.data.publishDate).getTime() - new Date(a.data.publishDate).getTime();
});

// Enhanced journey items with adaptive sizing for 4-column layout
const enhancedJourneyItems: any[] = [];
const allSizes = ['standard', 'short', 'tall', 'wide'];

for (let i = 0; i < sortedJourneyItems.length; i++) {
	const journeyItem = sortedJourneyItems[i];
	
	// Get the previous card's actual size (if any)
	const previousSize = enhancedJourneyItems[i - 1]?.adaptiveSize || '';
	
	// Available sizes (exclude previous to prevent adjacent duplicates)
	const availableSizes = previousSize ? allSizes.filter(size => size !== previousSize) : allSizes;
	
	let adaptiveSize: string;
	
	if (journeyItem.data.featured) {
		// Featured journey items prefer larger sizes
		const featuredSizes = availableSizes.filter(size => ['tall', 'wide'].includes(size));
		const finalSizes = featuredSizes.length > 0 ? featuredSizes : availableSizes;
		
		const featuredCount = enhancedJourneyItems.filter(p => p.data.featured).length;
		adaptiveSize = finalSizes[featuredCount % finalSizes.length] || 'tall';
	} else {
		// Regular journey items get balanced variety
		const regularCount = enhancedJourneyItems.filter(p => !p.data.featured).length;
		
		// Use golden ratio for natural variation
		const sizeIndex = Math.floor((regularCount * 1.618 + regularCount * 5) % availableSizes.length);
		adaptiveSize = availableSizes[sizeIndex] || 'standard';
	}
	
	// Add to enhanced array with assigned size
	enhancedJourneyItems.push({ ...journeyItem, adaptiveSize });
}
---

<CraftLayout title="Prasathup - Journey" pageName="journey">
	<!-- Header control panel with ghost search -->
	<div slot="header" class="header-container">
		<h1 class="craft-title journey-title">Journey</h1>
		<p class="craft-subtitle">
			A visual representation of my life's journey through time, mapping 100 years as 5,200 weeks inspired by <a href="https://youtu.be/JXeJANDKwDc" target="_blank" rel="noopener noreferrer">Kurz Gesagt</a>. It is a reminder for me to once in a while pause, reflect, and appreciate. 
			Realizing that I exist for a finite time in this vast universe helps me to stay grounded and focused on the present. It helps me to navigate challenging times and guides me to use the limited time meaningfully and with optimism.
		</p>
		
		<!-- Ghost Search positioned relative to title -->
		<GhostSearch searchType="journey" />
				</div>

	<!-- Journey Calendar Component -->
	<section class="calendar-section">
		<JourneyCalendarCanvas />
	</section>

	<!-- Three quote cards with proper layout -->
    <div class="quote-cards-container">
        <div class="quote-card glass-panel">
            <h3>Albert Einstein</h3>
            <p>Ich habe keine besonderen Talente. Ich bin nur leidenschaftlich neugierig.</p>
        </div>
        <div class="quote-card glass-panel">
            <h3>கணியன் பூங்குன்றனார்</h3>
            <p>யாதும் ஊரே யாவரும் கேளிர் (Yātum ūrē yāvarum kēḷir)</p>
        </div>
        <div class="quote-card glass-panel">
            <h3>Neil deGrasse Tyson</h3>
            <p>We are all connected; To each other, biologically. To the earth, chemically. To the rest of the universe atomically.</p>
        </div>
    </div>

	<!-- Journey Content Grid with 3-column layout -->
	{sortedJourneyItems.length > 0 && (
    <ContentGrid columns={3} theme="journey" class="journey-main-cards" gap="8px">
            {enhancedJourneyItems.map((journeyItem: any, idx: number) => {
                const palette = ['var(--rainbow-journey)','var(--rainbow-projects)','var(--rainbow-notes)','var(--rainbow-lab)','var(--rainbow-bio)'];
                const prev = idx > 0 ? palette[(idx - 1) % palette.length] : '';
                let color = palette[idx % palette.length];
                if (color === prev) color = palette[(idx + 2) % palette.length];
                return (
                    <MediaCard 
                        entry={journeyItem}
                        adaptiveSize={journeyItem.adaptiveSize}
                        class="craft-card journey-card"
                        animationDelay={`${idx * 150}ms`}
                        titleColorVar={color}
                        priority={idx < 12}
                    />
                );
            })}
        </ContentGrid>
	)}

</CraftLayout>

<style>
	/* Header container for relative positioning */
	.header-container {
		position: relative;
	}

	/* Journey-specific title styling with cosmic/time aesthetic */
	.journey-title {
		font-size: clamp(2rem, 5vw, 3.5rem);
		font-weight: 500;
		line-height: 1.2;
		color: var(--text-primary, rgba(255, 255, 255, 0.9));
		margin: 0 0 var(--space-sm, 0.5rem) 0;
		font-family: 'Ubuntu', system-ui, sans-serif;
		background: linear-gradient(135deg, 
			rgba(140, 170, 238, 0.9),  /* Cosmic blue */
			rgba(245, 189, 230, 0.8),  /* Nebula pink */
			rgba(166, 209, 137, 0.8),  /* Aurora green */
			rgba(239, 159, 118, 0.9)   /* Stellar orange */
		);
		-webkit-background-clip: text;
		-webkit-text-fill-color: transparent;
		background-clip: text;
	}

	/* Light mode journey title - solid dark text (no gradient) */
	html:not(.dark) .journey-title {
		background: none !important;
		-webkit-background-clip: unset !important;
		-webkit-text-fill-color: #1A5C8B !important;
		background-clip: unset !important;
		color: #1A5C8B !important;
	}

	.craft-subtitle {
		font-size: clamp(1rem, 2vw, 1.25rem);
		line-height: 1.6;
		color: var(--text-secondary, rgba(255, 255, 255, 0.7));
		margin: 0 0 var(--space-lg, 2rem) 0;
		max-width: 2000px;
		font-family: 'Ubuntu', system-ui, sans-serif;
		font-weight: 300;
	}

	.craft-subtitle a {
		color: var(--rainbow-journey);
		text-decoration: none;
		text-shadow: 0 0 8px rgba(140, 170, 238, 0.5);
		transition: text-shadow 0.3s ease, color 0.3s ease;
	}

	.craft-subtitle a:hover {
		color: var(--rainbow-projects);
		text-shadow: 0 0 16px rgba(245, 189, 230, 0.7);
	}

	/* Light mode subtitle text */
	html:not(.dark) .craft-subtitle {
		color: rgba(0, 0, 0, 0.7) !important;
	}

	/* Calendar section - now contains the canvas that sizes to content */
	.calendar-section {
		margin: 0;
		padding: 0;
		background: transparent;
		border: none;
		border-radius: 0;
		/* Let the canvas size to its content */
		width: 100%;
		height: auto;
		position: relative;
		overflow: hidden;
		/* Ensure page remains scrollable on mobile */
		touch-action: pan-y;
		/* REDUCED BOTTOM MARGIN for better spacing */
		margin-bottom: 2rem;
  }

	/* Light mode calendar: transparent background for canvas */
	html:not(.dark) .calendar-section {
		background: transparent;
		border: none;
	}

	/* Placeholder cards for journey content (no border, no hover animation) */
	.placeholder-card {
		padding: 1.5rem;
		text-align: center;
		background: rgba(255, 255, 255, 0.05);
		border: none;
		border-radius: 12px;
		transition: none;
	}

	/* No hover effects */
	/* (intentionally no :hover rule so background never changes) */

	.placeholder-card h3 {
		font-size: 1.25rem;
		color: var(--text-primary, rgba(255, 255, 255, 0.9));
		margin: 0 0 0.75rem 0;
		font-weight: 500;
	}

	.placeholder-card p {
		color: var(--text-secondary, rgba(255, 255, 255, 0.6));
		font-size: 0.875rem;
		line-height: 1.5;
		margin: 0;
	}

	/* Light mode placeholder cards */
	html:not(.dark) .placeholder-card {
		background: rgba(0, 0, 0, 0.03);
		border: none;
	}

	/* No light-mode hover changes */

	html:not(.dark) .placeholder-card h3 {
		color: rgba(0, 0, 0, 0.9) !important;
  }

	html:not(.dark) .placeholder-card p {
		color: rgba(0, 0, 0, 0.6) !important;
	}

	/* Responsive adjustments */
	@media (max-width: 768px) {
		.journey-title {
			font-size: clamp(1.75rem, 8vw, 2.5rem);
		}
		
		.craft-subtitle {
			font-size: 1rem;
		}

		.calendar-section {
			margin: 0;
			padding: 0;
			/* Let canvas size to content on mobile */
			width: 100%;
			height: auto;
			margin-bottom: 1.5rem; /* REDUCED for better spacing on mobile */
		}
	}



	/* Disable expensive transitions on large containers for Journey page only */
	body.page-journey,
	.page-journey .simple-background,
	.page-journey .calendar-section,
	.page-journey .calendar-main-card {
	  transition: none !important;
	}

	.media-card {
		transition: transform 0.2s ease, box-shadow 0.2s ease;
		opacity: 1;
		transform: translateY(0);
	}

    /* Remove hover elevation on Journey masonry cards */
    :global(.journey-main-cards .card-link:hover) { box-shadow: none !important; }

    /* Thought bubbles: hand-sketched style (smaller, no glow, non-overlapping) */
    :global(.journey-main-cards .card-link[data-collection="journey"])::after {
		content: '';
		position: absolute;
		bottom: 8px;
		right: 8px;
		width: 48px;
		height: 48px;
		pointer-events: none;
		background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='48' height='48' viewBox='0 0 48 48'><defs><filter id='r' x='-10%' y='-10%' width='120%' height='120%'><feTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='1' seed='3' result='n'/><feDisplacementMap in='SourceGraphic' in2='n' scale='0.6' xChannelSelector='R' yChannelSelector='G'/></filter></defs><g fill='none' stroke='white' stroke-linecap='round' stroke-linejoin='round' filter='url(%23r)'><g opacity='0.45'><ellipse cx='16' cy='16' rx='8.2' ry='7.6' stroke-width='1.25'/><ellipse cx='16' cy='16' rx='7.6' ry='7.2' stroke-width='0.9' transform='rotate(-3 16 16)'/></g><g opacity='0.45'><ellipse cx='30' cy='27' rx='5.6' ry='5.2' stroke-width='1.2'/><ellipse cx='30' cy='27' rx='5.1' ry='4.8' stroke-width='0.85' transform='rotate(4 30 27)'/></g><g opacity='0.45'><ellipse cx='38' cy='36' rx='3.6' ry='3.3' stroke-width='1.1'/><ellipse cx='38' cy='36' rx='3.2' ry='3.0' stroke-width='0.8' transform='rotate(-6 38 36)'/></g></g></svg>");
		background-repeat: no-repeat;
		background-position: center;
		background-size: contain;
		opacity: 1;
		z-index: 0;
	}

    /* Light theme stroke color */
    html:not(.dark) :global(.journey-main-cards .card-link[data-collection="journey"])::after {
		background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='48' height='48' viewBox='0 0 48 48'><defs><filter id='r' x='-10%' y='-10%' width='120%' height='120%'><feTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='1' seed='3' result='n'/><feDisplacementMap in='SourceGraphic' in2='n' scale='0.6' xChannelSelector='R' yChannelSelector='G'/></filter></defs><g fill='none' stroke='black' stroke-linecap='round' stroke-linejoin='round' filter='url(%23r)'><g opacity='0.38'><ellipse cx='16' cy='16' rx='8.2' ry='7.6' stroke-width='1.25'/><ellipse cx='16' cy='16' rx='7.6' ry='7.2' stroke-width='0.9' transform='rotate(-3 16 16)'/></g><g opacity='0.38'><ellipse cx='30' cy='27' rx='5.6' ry='5.2' stroke-width='1.2'/><ellipse cx='30' cy='27' rx='5.1' ry='4.8' stroke-width='0.85' transform='rotate(4 30 27)'/></g><g opacity='0.38'><ellipse cx='38' cy='36' rx='3.6' ry='3.3' stroke-width='1.1'/><ellipse cx='38' cy='36' rx='3.2' ry='3.0' stroke-width='0.8' transform='rotate(-6 38 36)'/></g></g></svg>");
	}

	/* Quote cards: disable any hover and transitions */
	.quote-card { 
		transition: none !important; 
		/* Increase base shadow ~50% for stronger separation */
		box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15) !important; /* was 0 8px 32px */
	}
	/* Light mode: 50% increase from 0 4px 12px to 0 6px 18px */
	html:not(.dark) .quote-card {
		box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15) !important; /* was 0 4px 12px */
	}
	/* Ensure absolutely no hover visual change */
	.quote-card:hover {
		box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15) !important;
		transform: none !important;
	}
	html:not(.dark) .quote-card:hover {
		box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15) !important;
	}

	/* Ensure Journey uses the same smooth fade as Projects */
	:global(.journey-main-cards .card-content) {
		mask-image: linear-gradient(to bottom, black 70%, transparent 100%);
		-webkit-mask-image: linear-gradient(to bottom, black 70%, transparent 100%);
	}

    /* Quote cards container - match journey grid width */
    .quote-cards-container {
        display: flex;
        gap: 1rem;
        margin: 0 auto 2rem auto;
        padding: 0 1rem;
        max-width: 1400px; /* Match journey grid (3-col) */
        justify-content: center;
        align-items: stretch;
    }

    /* Individual quote cards - two equal, one wider */
    .quote-card {
        min-width: 0; /* Allow flex items to shrink below content size */
        padding: 1.5rem;
        text-align: center;
        background: rgba(255, 255, 255, 0.05);
        border: none;
        border-radius: 12px;
        transition: none;
        display: flex;
        flex-direction: column;
        justify-content: center;
        min-height: 150px;
    }

    /* First two cards: equal width */
    .quote-card:first-child,
    .quote-card:nth-child(2) {
        flex: 0 0 calc(25% - 0.5rem); /* 25% each minus half the gap */
    }

    /* Third card (Neil deGrasse Tyson): wider */
    .quote-card:last-child {
        flex: 0 0 calc(50% - 0.5rem); /* 50% minus half the gap */
    }

    /* Quote card typography */
    .quote-card h3 {
        font-size: 1.25rem;
        color: var(--text-primary, rgba(255, 255, 255, 0.9));
        margin: 0 0 0.75rem 0;
        font-weight: 500;
        line-height: 1.3;
    }

    .quote-card p {
        color: var(--text-secondary, rgba(255, 255, 255, 0.6));
        font-size: 1rem;
        line-height: 1.5;
        margin: 0;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Light mode quote cards */
    html:not(.dark) .quote-card {
        background: rgba(0, 0, 0, 0.03);
        border: none;
    }

    html:not(.dark) .quote-card h3 {
        color: rgba(0, 0, 0, 0.9) !important;
    }

    html:not(.dark) .quote-card p {
        color: rgba(0, 0, 0, 0.6) !important;
    }


    /* Responsive breakpoints for quote cards - match masonry layout */
    @media (min-width: 1024px) {
        .quote-cards-container {
            padding: 0 24px; /* Match masonry layout padding */
            gap: 20px; /* Match masonry layout gap */
        }
    }

    @media (max-width: 1023px) and (min-width: 640px) {
        .quote-cards-container {
            gap: 18px; /* Match masonry layout gap */
            padding: 0 20px; /* Match masonry layout padding */
        }
        
        .quote-card {
            padding: 1.25rem;
            min-height: 140px;
        }
        
        .quote-card h3 {
            font-size: 1.125rem;
        }
        
        .quote-card p {
            font-size: 1.125rem;
        }
    }

    @media (max-width: 639px) {
        .quote-cards-container {
            flex-direction: column;
            gap: 16px; /* Match masonry layout gap */
            padding: 0 16px; /* Match masonry layout padding */
            max-width: 100%;
        }
        
        .quote-card {
            padding: 1.5rem;
            min-height: 120px;
            flex: 1; /* Reset flex for mobile */
        }
        
        .quote-card h3 {
            font-size: 1.25rem;
        }
        
        .quote-card p {
            font-size: 1.125rem;
        }
    }

    @media (max-width: 480px) {
        .quote-cards-container {
            padding: 0 16px;
            gap: 16px;
        }
        
        .quote-card {
            padding: 1.25rem;
            min-height: 110px;
        }
        
        .quote-card h3 {
            font-size: 1.125rem;
        }
        
        .quote-card p {
            font-size: 1rem;
        }
    }

    /* Proper spacing between quote cards and main content */
    .quote-cards-container {
        margin-bottom: var(--section-gap, 2rem);
    }
    :global(.journey-main-cards) {
        margin-top: var(--card-gap, 1rem);
    }

	/* Mobile styles for main journey cards - properly centered */
	@media (max-width: 639px) {
		:global(.journey-main-cards) > :global(*) {
			min-width: auto !important;
			max-width: 100% !important;
			width: 100% !important;
		}
		
        /* Also target the card-link directly for higher specificity */
        :global(.journey-main-cards .card-link) {
			min-width: auto !important;
			max-width: 100% !important;
			width: 100% !important;
		}
	}

	/* Ensure page remains scrollable on mobile */
	body {
		touch-action: pan-y; /* Allow vertical scrolling */
		overflow-y: auto;
	}

	/* Prevent calendar from interfering with page scroll */
	.calendar-section {
		touch-action: pan-y; /* Allow vertical scrolling through the calendar */
	}

	/* Fix iOS scroll issues */
	.calendar-section * {
		-webkit-overflow-scrolling: touch;
	}
</style> 