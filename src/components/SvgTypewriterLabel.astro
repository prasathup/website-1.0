---
// SvgTypewriterLabel.astro - Typewriter text effect with HeartStopper SVG images
// Now using the shared typewriter animation utilities
// Remove import of matrixAnimations.css and matrixAnimationUtils.js

export interface Props {
  text: string;
  color: string;
  class?: string; // Allow optional class prop
}

const { text, color, class: className } = Astro.props;
const uniqueId = `svg-typewriter-label-${Math.random().toString(36).substring(2, 9)}`;

// Get all SVG files from HeartStopperSVG directory at build time
// The path is relative to the public directory
const svgDirectory = '/HeartStopperSVG/';
const svgCount = 22; // We have 22 SVGs in the directory

// (No direct TypeScript imports in Astro frontmatter)
---

<span 
  id={uniqueId}
  class:list={[
    "svg-typewriter-label absolute top-[40px] left-1/2 -translate-x-1/2 font-mono text-xs font-medium",
    "pointer-events-none whitespace-nowrap transition-all duration-200",
    // Simple hover-only behavior restricted to pointer devices
    "opacity-0 [@media(hover:hover)]:group-hover:opacity-100",
    "translate-y-1 [@media(hover:hover)]:group-hover:translate-y-0",
    className
  ]}
  style={`color: ${color}`}
  data-text={text}
  data-color={color}
  data-svg-directory={svgDirectory}
  data-svg-count={svgCount}
>
  <!-- Render spans for each character to be replaced with SVGs -->
  {text.split('').map(char => (
    <span class="svg-typewriter-char inline-block relative" data-char={char}>
      <span class="original-char opacity-0">{char}</span>
      <!-- SVG container that will be populated by JavaScript -->
      <span class="svg-container absolute top-0 left-0 w-full h-full flex items-center justify-center">
      </span>
    </span>
  ))}
</span>

<style>
  /* SVG Typewriter effect styling - only keep styles specific to SVG handling */
  .svg-typewriter-char {
    display: inline-block;
    position: relative;
    width: 1em;
    height: 1em;
    vertical-align: middle;
  }

  .original-char {
    visibility: hidden;
    opacity: 0;
  }

  .svg-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .svg-container img,
  .svg-container svg {
    width: 100%;
    height: 100%;
    object-fit: contain;
    transition: opacity 300ms cubic-bezier(0.4, 0, 0.2, 1), transform 300ms cubic-bezier(0.4, 0, 0.2, 1);
  }

  .svg-container.changing img,
  .svg-container.changing svg {
    transform: scale(1.08);
    filter: brightness(1.3);
  }

  .svg-final {
    opacity: 1;
  }
</style>

<script>
  // --- Typewriter Animation Integration ---
  if (typeof window !== 'undefined') {
    // Global map to track active typewriter animations
    if (!(window as any)['svgTypewriterAnimations']) {
      (window as any)['svgTypewriterAnimations'] = new Map();
    }

    async function setupTypewriterAnimation(label: any) {
      const uniqueId = label.id;
      if (!uniqueId) return;
      const text = label.getAttribute('data-text') || '';
      const svgDirectory = label.getAttribute('data-svg-directory') || '/HeartStopperSVG/';
      const svgCount = parseInt(label.getAttribute('data-svg-count') || '22', 10);
      // Dynamically import the utility and engine
      const { preloadTypewriterSvgs } = await import('../lib/typewriterUtils');
      const { TypewriterEngine } = await import('../lib/typewriterEngine');
      const svgPaths = preloadTypewriterSvgs(svgDirectory, svgCount);
      const config = { 
        text, 
        svgPaths,
        stepConfig: {
          maxSvgs: 3,        // 3 sketches (was 2) for slightly more variety
          svgDuration: 280,  // Slower sketches (was 200) to see the art
          revealDuration: 500 // Slower fade in (was 400) for calmness
        },
        timing: {
          characterDelay: 150 // Slower wave (was 120)
        }
      };
      const engine = new TypewriterEngine(label, config);

      // Store in global map
      (window as any)['svgTypewriterAnimations'].set(uniqueId, { engine, element: label });

      // Animation handlers - consistent behavior across all screen sizes
      const start = () => {
        (window as any)['svgTypewriterAnimations'].forEach((entry: any, animId: any) => {
          if (animId !== uniqueId && entry.engine) entry.engine.stop();
        });
        engine.start();
      };
      const stop = () => {
        engine.resetToText();
      };

      // Find parent with hover effect
      const parent = label.closest('.group') || label.parentElement;
      if (!parent) return;
      
      // Remove existing listeners to prevent conflicts
      parent.removeEventListener('mouseenter', start);
      parent.removeEventListener('mouseleave', stop);
      
      // Add mouse events for all screen sizes - consistent behavior
      parent.addEventListener('mouseenter', start, { passive: true });
      parent.addEventListener('mouseleave', stop, { passive: true });
    }

    async function initializeAllTypewriterLabels() {
      const labels = document.querySelectorAll('.svg-typewriter-label');
      for (const label of labels as any) {
        await setupTypewriterAnimation(label);
      }
    }

    // Clean up on page transitions
    document.addEventListener('astro:before-swap', () => {
      if ((window as any)['svgTypewriterAnimations']) {
        (window as any)['svgTypewriterAnimations'].forEach((entry: any) => {
          if (entry && entry.engine) entry.engine.stop();
        });
        (window as any)['svgTypewriterAnimations'].clear();
      }
    });

    document.addEventListener('DOMContentLoaded', initializeAllTypewriterLabels);
    document.addEventListener('astro:page-load', initializeAllTypewriterLabels);
  }
</script> 